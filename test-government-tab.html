<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>정부 보도자료 탭 테스트</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .test-result { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .log { background: #f8f9fa; font-family: monospace; padding: 10px; white-space: pre-wrap; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>🏛️ 정부 보도자료 탭 기능 테스트</h1>
    
    <div class="test-result">
        <h3>1. 메인 앱 로드 및 정부 탭 클릭 테스트</h3>
        <button onclick="testGovernmentTab()">정부 보도자료 탭 테스트</button>
        <div id="tab-test" class="log"></div>
    </div>

    <div class="test-result">
        <h3>2. API 직접 호출 테스트</h3>
        <button onclick="testAPI()">API 직접 테스트</button>
        <div id="api-test" class="log"></div>
    </div>

    <div class="test-result">
        <h3>3. 기관 필터 테스트</h3>
        <button onclick="testAgencyFilter()">기관 필터 테스트</button>
        <div id="filter-test" class="log"></div>
    </div>

    <script>
        async function testGovernmentTab() {
            const logDiv = document.getElementById('tab-test');
            logDiv.textContent = '정부 보도자료 탭 테스트 시작...\n';

            try {
                // 메인 애플리케이션 iframe 생성
                const iframe = document.createElement('iframe');
                iframe.src = '/';
                iframe.style.width = '100%';
                iframe.style.height = '600px';
                iframe.style.border = '1px solid #ddd';
                
                // iframe 로드 완료 대기
                iframe.onload = function() {
                    logDiv.textContent += 'iframe 로드 완료\n';
                    
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        logDiv.textContent += '문서 접근 성공\n';
                        
                        // 정부 보도자료 탭 버튼 찾기
                        const govButton = iframeDoc.querySelector('[data-tab="government"]');
                        if (govButton) {
                            logDiv.textContent += '정부 보도자료 탭 버튼 발견\n';
                            
                            // 클릭 이벤트 시뮬레이션
                            govButton.click();
                            logDiv.textContent += '정부 보도자료 탭 클릭 완료\n';
                            
                            // 잠시 대기 후 결과 확인
                            setTimeout(() => {
                                const govTab = iframeDoc.getElementById('government-tab');
                                if (govTab && govTab.classList.contains('active')) {
                                    logDiv.textContent += '✅ 정부 보도자료 탭 활성화 성공\n';
                                    
                                    // 뉴스 목록 확인
                                    const newsList = iframeDoc.getElementById('government-news-list');
                                    if (newsList) {
                                        logDiv.textContent += `뉴스 목록 컨테이너: ${newsList.innerHTML.substring(0, 200)}...\n`;
                                    }
                                } else {
                                    logDiv.textContent += '❌ 정부 보도자료 탭 활성화 실패\n';
                                }
                            }, 2000);
                            
                        } else {
                            logDiv.textContent += '❌ 정부 보도자료 탭 버튼을 찾을 수 없음\n';
                        }
                        
                    } catch (error) {
                        logDiv.textContent += `❌ iframe 내부 접근 오류: ${error.message}\n`;
                    }
                };
                
                // 테스트 결과 영역에 iframe 추가
                const testDiv = document.getElementById('tab-test').parentNode;
                testDiv.appendChild(iframe);
                
            } catch (error) {
                logDiv.textContent += `❌ 테스트 오류: ${error.message}\n`;
            }
        }

        async function testAPI() {
            const logDiv = document.getElementById('api-test');
            logDiv.textContent = 'API 직접 테스트 시작...\n';

            try {
                // 뉴스 API 테스트
                logDiv.textContent += '1. 뉴스 목록 API 호출...\n';
                const newsResponse = await fetch('/api/news?agency=all&page=1&limit=6');
                const newsResult = await newsResponse.json();
                
                logDiv.textContent += `뉴스 API 응답: ${JSON.stringify(newsResult, null, 2)}\n\n`;
                
                // 통계 API 테스트  
                logDiv.textContent += '2. 통계 API 호출...\n';
                const statsResponse = await fetch('/api/news/stats');
                const statsResult = await statsResponse.json();
                
                logDiv.textContent += `통계 API 응답: ${JSON.stringify(statsResult, null, 2)}\n\n`;
                
                if (newsResult.success && statsResult.success) {
                    logDiv.textContent += '✅ 모든 API 정상 작동\n';
                } else {
                    logDiv.textContent += '❌ 일부 API 오류 발생\n';
                }
                
            } catch (error) {
                logDiv.textContent += `❌ API 테스트 오류: ${error.message}\n`;
            }
        }

        async function testAgencyFilter() {
            const logDiv = document.getElementById('filter-test');
            logDiv.textContent = '기관 필터 테스트 시작...\n';

            try {
                const agencies = [
                    { code: 'all', name: '전체' },
                    { code: 'fsc', name: '금융위원회' },
                    { code: 'fss', name: '금융감독원' },
                    { code: 'ftc', name: '공정거래위원회' }
                ];
                
                for (const agency of agencies) {
                    logDiv.textContent += `${agency.name} (${agency.code}) 테스트...\n`;
                    
                    const response = await fetch(`/api/news?agency=${agency.code}&page=1&limit=3`);
                    const result = await response.json();
                    
                    if (result.success) {
                        const count = result.data?.length || 0;
                        logDiv.textContent += `  ✅ ${count}개 데이터 확인\n`;
                        
                        if (count > 0 && result.data[0].title) {
                            logDiv.textContent += `  📄 샘플: ${result.data[0].title.substring(0, 50)}...\n`;
                        }
                    } else {
                        logDiv.textContent += `  ❌ API 오류: ${result.error}\n`;
                    }
                }
                
                logDiv.textContent += '\n✅ 기관 필터 테스트 완료\n';
                
            } catch (error) {
                logDiv.textContent += `❌ 기관 필터 테스트 오류: ${error.message}\n`;
            }
        }
    </script>
</body>
</html>