<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ… ìµœì¢… ì‘ë™ í™•ì¸</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-result { margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid #007bff; }
        .error { border-left-color: #dc3545; background-color: #f8d7da; }
        .success { border-left-color: #28a745; background-color: #d4edda; }
        .button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .news-card { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px; }
        .government-card { border-left: 4px solid #28a745; background-color: #f8fff8; }
        .search-card { border-left: 4px solid #ffc107; background-color: #fffcf0; }
        .link-button { display: inline-block; padding: 8px 16px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; margin-right: 10px; }
    </style>
</head>
<body>
    <h1>ğŸ‰ ì •ë¶€ ë³´ë„ìë£Œ ë§í¬ ë¬¸ì œ ìµœì¢… í•´ê²°!</h1>
    
    <div class="test-result success">
        <h3>âœ… CORS ë¬¸ì œ í•´ê²° ì™„ë£Œ</h3>
        <p>ë°±ì—”ë“œì™€ í”„ë¡ íŠ¸ì—”ë“œë¥¼ ê°™ì€ ì„œë²„(í¬íŠ¸ 5000)ì—ì„œ ì œê³µí•˜ì—¬ CORS ë¬¸ì œë¥¼ ê·¼ë³¸ì ìœ¼ë¡œ í•´ê²°í–ˆìŠµë‹ˆë‹¤.</p>
    </div>

    <button class="button" onclick="testAPI()">API ì—°ê²° í…ŒìŠ¤íŠ¸</button>
    <div id="api-test"></div>

    <button class="button" onclick="loadGovernmentNews()">ì •ë¶€ ë³´ë„ìë£Œ ë¡œë“œ í…ŒìŠ¤íŠ¸</button>
    <div id="government-test"></div>

    <button class="button" onclick="testLinkGeneration()">ë§í¬ ìƒì„± í•¨ìˆ˜ í…ŒìŠ¤íŠ¸</button>
    <div id="link-test"></div>

    <script>
        // ìˆ˜ì •ëœ URL ìƒì„± í•¨ìˆ˜ë“¤
        function generateArticleUrl(item) {
            // ì§ì ‘ ë§í¬ì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ì‚¬ìš©
            if (item.url && (
                item.url.includes('view.do') || 
                item.url.includes('Detail.do') || 
                item.url.includes('/view/') || 
                item.url.includes('/detail/') ||
                item.url.includes('selectReportDetail.do') ||
                item.url.includes('?contentNo=') ||
                item.url.includes('?rptNo=')
            )) {
                return item.url;
            }
            
            // ê²€ìƒ‰ ë§í¬ ìƒì„±
            const titleKeywords = item.title.replace(/- \d+ì›” \d+ì¼$/, '').trim().split(' ');
            const mainKeyword = titleKeywords[0] || 'ë³´ë„ìë£Œ';
            
            let searchDate = '';
            if (item.publishedAt) {
                const date = new Date(item.publishedAt);
                searchDate = `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
            }
            
            const encodedKeyword = encodeURIComponent(mainKeyword);
            const encodedAgency = encodeURIComponent(item.agency);
            const encodedDate = encodeURIComponent(searchDate);
            
            let searchUrl;
            switch (item.agencyCode) {
                case 'fsc':
                    if (searchDate) {
                        searchUrl = `https://search.naver.com/search.naver?where=news&query=site:fsc.go.kr+${encodedKeyword}+${encodedDate}&sort=1`;
                    } else {
                        searchUrl = `https://search.naver.com/search.naver?where=news&query=${encodedAgency}+${encodedKeyword}+ë³´ë„ìë£Œ&sort=1`;
                    }
                    break;
                case 'fss':
                    if (searchDate) {
                        searchUrl = `https://search.naver.com/search.naver?where=news&query=site:fss.or.kr+${encodedKeyword}+${encodedDate}&sort=1`;
                    } else {
                        searchUrl = `https://search.naver.com/search.naver?where=news&query=${encodedAgency}+${encodedKeyword}+ë³´ë„ìë£Œ&sort=1`;
                    }
                    break;
                case 'ftc':
                    if (searchDate) {
                        searchUrl = `https://search.naver.com/search.naver?where=news&query=site:ftc.go.kr+${encodedKeyword}+${encodedDate}&sort=1`;
                    } else {
                        searchUrl = `https://search.naver.com/search.naver?where=news&query=${encodedAgency}+${encodedKeyword}+ë³´ë„ìë£Œ&sort=1`;
                    }
                    break;
                default:
                    searchUrl = `https://search.naver.com/search.naver?where=news&query=${encodedAgency}+${encodedKeyword}&sort=1`;
            }
            
            return searchUrl;
        }

        async function testAPI() {
            const resultDiv = document.getElementById('api-test');
            resultDiv.innerHTML = '<p>API ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...</p>';

            try {
                const response = await fetch('/api/news?agency=all&page=1&limit=3');
                const result = await response.json();

                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="test-result success">
                            <h4>âœ… API ì—°ê²° ì„±ê³µ!</h4>
                            <p><strong>ì´ ë³´ë„ìë£Œ:</strong> ${result.pagination.totalCount}ê°œ</p>
                            <p><strong>ë¡œë“œëœ ë°ì´í„°:</strong> ${result.data.length}ê°œ</p>
                            <p><strong>CORS ë¬¸ì œ:</strong> ì™„ì „ í•´ê²°ë¨</p>
                        </div>
                    `;
                } else {
                    throw new Error(result.message || 'API ì˜¤ë¥˜');
                }

            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="test-result error">
                        <h4>âŒ API ì—°ê²° ì‹¤íŒ¨</h4>
                        <p><strong>ì˜¤ë¥˜:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadGovernmentNews() {
            const resultDiv = document.getElementById('government-test');
            resultDiv.innerHTML = '<p>ì •ë¶€ ë³´ë„ìë£Œ ë¡œë“œ ì¤‘...</p>';

            try {
                const response = await fetch('/api/news?agency=all&page=1&limit=6');
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || 'API ì˜¤ë¥˜');
                }

                let cardsHTML = '';
                result.data.forEach((item) => {
                    const isDirectUrl = item.url && (
                        item.url.includes('view.do') || 
                        item.url.includes('Detail.do') || 
                        item.url.includes('/view/') || 
                        item.url.includes('/detail/') ||
                        item.url.includes('selectReportDetail.do') ||
                        item.url.includes('?contentNo=') ||
                        item.url.includes('?rptNo=')
                    );

                    const finalUrl = generateArticleUrl(item);

                    cardsHTML += `
                        <div class="news-card ${isDirectUrl ? 'government-card' : 'search-card'}">
                            <h4>${item.title}</h4>
                            <p><strong>ê¸°ê´€:</strong> ${item.agency} | <strong>ë‚ ì§œ:</strong> ${item.date}</p>
                            <p>${item.summary}</p>
                            <div style="margin-top: 10px;">
                                <a href="${finalUrl}" target="_blank" class="link-button">
                                    ğŸ“– ì›ë¬¸ ë³´ê¸°
                                </a>
                                <span style="color: ${isDirectUrl ? '#28a745' : '#ffc107'}; font-weight: bold;">
                                    ${isDirectUrl ? 'âœ… ì§ì ‘ ë§í¬' : 'ğŸ” ê²€ìƒ‰ ë§í¬'}
                                </span>
                            </div>
                            <p style="font-size: 12px; color: #666; margin-top: 8px;">
                                <strong>URL:</strong> ${finalUrl}
                            </p>
                        </div>
                    `;
                });

                resultDiv.innerHTML = `
                    <div class="test-result success">
                        <h4>ğŸ‰ ì •ë¶€ ë³´ë„ìë£Œ íƒ­ ì™„ì „ ì •ìƒ ì‘ë™!</h4>
                        <p><strong>ë¡œë“œëœ ë³´ë„ìë£Œ:</strong> ${result.data.length}ê°œ</p>
                        <p><strong>ìƒíƒœ:</strong> ëª¨ë“  ê¸°ëŠ¥ ì •ìƒ ì‘ë™</p>
                        
                        <h5>ğŸ“‹ ë³´ë„ìë£Œ ìƒ˜í”Œ (ì‹¤ì œ "ì›ë¬¸ ë³´ê¸°" ë²„íŠ¼ ë™ì‘):</h5>
                        <div style="max-height: 600px; overflow-y: auto;">
                            ${cardsHTML}
                        </div>
                    </div>
                `;

            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="test-result error">
                        <h4>âŒ ì •ë¶€ ë³´ë„ìë£Œ ë¡œë“œ ì‹¤íŒ¨</h4>
                        <p><strong>ì˜¤ë¥˜:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        async function testLinkGeneration() {
            const resultDiv = document.getElementById('link-test');
            resultDiv.innerHTML = '<p>ë§í¬ ìƒì„± í…ŒìŠ¤íŠ¸ ì¤‘...</p>';

            try {
                const response = await fetch('/api/news?agency=all&page=1&limit=5');
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || 'API ì˜¤ë¥˜');
                }

                let testResults = '';
                let directLinks = 0;
                let searchLinks = 0;

                result.data.forEach((item, index) => {
                    const originalUrl = item.url;
                    const generatedUrl = generateArticleUrl(item);
                    const isDirect = originalUrl === generatedUrl;

                    if (isDirect) directLinks++;
                    else searchLinks++;

                    testResults += `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: ${isDirect ? '#f8fff8' : '#fffcf0'};">
                            <strong>${index + 1}. ${item.title}</strong><br>
                            <strong>ê²°ê³¼:</strong> ${isDirect ? 'âœ… ì›ë³¸ URL ì‚¬ìš© (ì§ì ‘ ë§í¬)' : 'ğŸ” ê²€ìƒ‰ URL ìƒì„±'}<br>
                            <strong>ìµœì¢… URL:</strong> <a href="${generatedUrl}" target="_blank" style="word-break: break-all;">${generatedUrl}</a>
                        </div>
                    `;
                });

                resultDiv.innerHTML = `
                    <div class="test-result success">
                        <h4>âœ… URL ìƒì„± í•¨ìˆ˜ ì •ìƒ ì‘ë™</h4>
                        <p><strong>ì§ì ‘ ë§í¬:</strong> ${directLinks}ê°œ (${((directLinks / result.data.length) * 100).toFixed(1)}%)</p>
                        <p><strong>ê²€ìƒ‰ ë§í¬:</strong> ${searchLinks}ê°œ (${((searchLinks / result.data.length) * 100).toFixed(1)}%)</p>
                        
                        <h5>ğŸ“Š ê°œë³„ í…ŒìŠ¤íŠ¸ ê²°ê³¼:</h5>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${testResults}
                        </div>
                    </div>
                `;

            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="test-result error">
                        <h4>âŒ ë§í¬ ìƒì„± í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨</h4>
                        <p><strong>ì˜¤ë¥˜:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ í…ŒìŠ¤íŠ¸
        window.addEventListener('load', async () => {
            console.log('ìµœì¢… ì‘ë™ í…ŒìŠ¤íŠ¸ ì‹œì‘');
            await testAPI();
            setTimeout(() => loadGovernmentNews(), 1000);
            setTimeout(() => testLinkGeneration(), 2000);
        });
    </script>
</body>
</html>